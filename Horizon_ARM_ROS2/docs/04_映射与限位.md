# 04 映射与限位（mapping.yaml 配置指南）

## 📝 配置文件概览

**文件位置**: `<ws>/arm-ros2/mapping.yaml`

该配置文件是整个系统的核心，定义了关节与电机的映射关系、运动限位和实时控制参数。

## 🔧 核心参数说明

### 🎯 映射配置

| 参数 | 类型 | 推荐值 | 说明 |
|------|------|-----------|------|
| `send_space` | string | `"motor"` | 下发空间：`motor`（电机角）或`output`（输出端角） |
| `apply_sign_in_ui` | bool | `true` | 是否在UI中应用方向映射 |
| `show_output_measured` | bool | `true` | 显示输出端角度而非电机角度 |

### ⚙️ 运动限位

| 参数 | 类型 | 单位 | 说明 |
|------|------|------|------|
| `pos_limit_deg` | array | 度 | 各关节角度上下限 `[min, max]` |
| `vel_limit_deg_s` | array | 度/秒 | 各关节速度上限（用于实时限速） |
| `wrap_deg` | array | 度 | 各关节角度套圈范围 |

### 🚀 实时控制

| 参数 | 类型 | 推荐值 | 说明 |
|------|------|-----------|------|
| `stream_min_delta_deg` | float | `0.02` | 死区阈值，小于此值的变化忽略 |
| `servo_rate_hz` | float | `50.0` | 实时循环频率 |
| `stream_use_direct` | bool | `true` | 直接位置模式或梯形轨迹模式 |

### 🎖️ 高级收敛参数（已在UI中实现）

| 参数 | 类型 | 推荐值 | 说明 |
|------|------|-----------|------|
| `stream_settle_tol_deg` | float | `0.5` | 判稳容差，在此范围内认为到达目标 |
| `stream_settle_hold_iters` | int | `5` | 连续命中次数，防止抹动 |
| `stream_finalize_with_abs` | bool | `true` | 判稳后的精确定位，确保最终精度 |

## 🔧 配置示例

### 基本配置示例
```yaml
# 关节-电机映射
motor_ids: [1, 2, 3, 4, 5, 6]
joints: ["1_join", "2_join", "3_join", "4_join", "5_join", "6_join"]

# 方向和减速比
sign: [1, 1, 1, -1, 1, -1]
gear_ratio: [62.0, 51.0, 51.0, 62.0, 12.0, 10.0]

# 关节限位
pos_limit_deg:
  - [-180, 180]  # J1
  - [-90, 90]    # J2
  - [-143, 143]  # J3
  - [-180, 180]  # J4
  - [-143, 143]  # J5
  - [-180, 180]  # J6

# 实时控制参数
servo_rate_hz: 50.0
stream_min_delta_deg: 0.02
stream_use_direct: true
```

## 🔍 常见问题解决

### 1️⃣ 实时控制“来回调”
**现象**: 实时模式下机械臂在目标位置附近抓返

**解决方案**:
- 增大 `stream_settle_tol_deg` 至 `1.0`
- 开启 `stream_finalize_with_abs: true`
- 调低 `servo_rate_hz` 至 `30-40`

### 2️⃣ 输出超限报警
**现象**: UI显示超限警告或动作受限

**解决方案**:
- 检查 `pos_limit_deg` 设置是否合理
- 确认 RViz 的 named state 与 UI 的 `home_output` 一致
- 检查 URDF 模型的 joint limits

### 3️⃣ 速度过快或过慢
**现象**: 机械臂移动太快或太慢

**解决方案**:
- 调整 `vel_limit_deg_s` 数组
- 修改 UI 中的默认速度 `max_speed_rpm`
- 检查 `gear_ratio` 是否正确

## 📊 性能调优建议

### 高精度应用
- `servo_rate_hz`: 100-200
- `stream_min_delta_deg`: 0.01
- `stream_settle_tol_deg`: 0.1

### 高速应用
- `servo_rate_hz`: 30-50  
- `stream_use_direct`: true
- `vel_limit_deg_s`: 根据需要增大

### 稳定性优先
- `stream_settle_hold_iters`: 8-10
- `stream_finalize_with_abs`: true
- `servo_rate_hz`: 20-30

> 📌 **提示**: 修改配置后需要重启系统才能生效
